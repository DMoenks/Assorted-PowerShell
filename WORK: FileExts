# Author: Moenks, Dominik
# Version: 1.0 (04.07.2014)
# Intention: Delete custom user actions for specified file extension on specified client computers

param([Parameter(Mandatory=$true)]
        [string[]]$ComputerNames,
        [Parameter(Mandatory=$true)]
        [string[]]$FileExtensions)

foreach ($computer in $ComputerNames)
{
    "Trying to reach system $($computer.ToUpperInvariant()) ..."
    if (Test-Connection $computer -Quiet)
    {
        $registry = [Microsoft.Win32.RegistryKey]::OpenRemoteBaseKey("Users", $computer)
        foreach ($user in $registry.GetSubKeyNames())
        {
            if ($user -match "^S(-\d+){4,}$")
            {
                foreach ($fileext in $FileExtensions)
                {
                    $tmpfileext = [Regex]::Match($fileext, "[0-9a-zA-Z]+").Value
                    "Trying to delete custom settings for extension *.$($tmpfileext.ToLowerInvariant()) ..."
                    try
                    {
                        $registry.DeleteSubKey("$user\Software\Microsoft\Windows\CurrentVersion\Explorer\FileExts\.$tmpfileext\UserChoice")
                        "Deleted custom settings for extension *.$($tmpfileext.ToLowerInvariant())."
                    }
                    catch [System.Management.Automation.MethodInvocationException]
                    {
                        "Found no custom settings for extension *.$($tmpfileext.ToLowerInvariant())"
                    }
                }
            }
        }
    }
    else
    {
        "Couldn't reach system $($computer.ToUpperInvariant())"
    }
}
